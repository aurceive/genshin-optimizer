import{X as Be,r as c,W as v,aj as Le,n as N,q as l,p as e,B as f,a4 as he,U as Q,M as Z,a$ as Y,aD as ee,b0 as je,av as pe,w as ve,b1 as ze,a6 as Fe,ak as Ne,al as X,am as He,an as xe,ao as We,ap as Ge,a7 as Ue,aq as $e,ar as Ve,as as Xe,at as Je,aA as q,z as b,R as ge,I as ne,ay as Qe,a9 as le,T,x as Ze,aE as Ye,aF as O,y,A as ke,a2 as fe,aH as te,ab as ye,b2 as ce,b3 as we,ad as Ie,b4 as Re,J as De,b5 as de,a3 as Ee,b6 as et,$ as be,aG as tt,aI as nt,aZ as st,aQ as it,aR as Se,aS as ot,aV as rt}from"./index-BMfPcVdQ.js";import{P as at,T as Me,a as lt,N as ct,I as dt,t as ut,Q as ht,e as pt,E as Te,f as gt,U as $,g as ft,o as Ct,S as mt,W as xt,h as yt,i as bt,j as St,A as Lt,B as vt,O as kt,F as wt,C as It,H as Rt,J as Dt,K as Et,M as Mt}from"./Checkroom-D8pyZg6D.js";import{a as K,C as Tt,L as Kt,b as Ot,D as At}from"./UploadCard-BIYDAKMr.js";import{M as P,D as U,r as Ke,b as Pt,d as qt,C as _t}from"./StatDisplay-CnHqEg03.js";import{S as E,b as Ce,c as Bt,d as jt,a as zt,C as Ft,u as Nt}from"./CharacterEditor-dItMqxS1.js";import{u as Ht,a as Wt,g as Oe}from"./LightConeTrans-DmHGyZH_.js";import{C as H}from"./CardHeader-D3PR3t1U.js";import{C as w,G as j}from"./Grid-Bf36i-JH.js";import{D as Gt,b as se}from"./BusinessCenter-CJvqCUft.js";import{u as me}from"./useBoolState-BDz5LJDl.js";import{a as Ae,R as B,b as Ut}from"./RelicSetAutocomplete-DtD9dY99.js";import{C as $t}from"./CardActionArea-BKYWnAl8.js";import"./InfoTooltip-FTR_BME6.js";function ue(n){const[t,s]=Be();return c.useEffect(()=>n.followAny((i,r)=>r==="update"&&s()),[n,s]),t}function W(n){const{database:t}=v();return Le(t.charOpts,n)}function Vt({levelLow:n,levelHigh:t,setLow:s,setHigh:i,setBoth:r,dark:o=!1,disabled:a=!1,showLevelText:h=!1}){const{t:p}=N("lightcone"),[d,u]=c.useState(n),[S,g]=c.useState(t),x=c.useCallback((C,m)=>{if(typeof m=="number")throw new TypeError;const[R,k]=m;u(R),g(k)},[u,g]);return c.useEffect(()=>u(n),[u,n]),c.useEffect(()=>g(t),[g,t]),l(f,{sx:{width:"100%",display:"flex",alignItems:"center",bgcolor:o?"contentNormal.main":"contentLight.main",overflow:"visible"},children:[l(f,{sx:{width:"max-content",height:32,display:"flex"},children:[h?l(he,{children:[e("span",{style:{padding:"0 1em",width:"max-content",borderRadius:"4px 0 0 4px",display:"flex",justifyContent:"center",alignItems:"center",color:"rgba(255,255,255,0.9)",backgroundColor:"rgb(30,120,200)"},children:p("levelSliderTitle")}),e(K,{orientation:"vertical",flexItem:!0})]}):void 0,e(Z,{value:d,onChange:C=>s(Q(C??0,0,t)),sx:{px:1,width:"3em"},inputProps:{sx:{textAlign:h?"right":"center"}},disabled:a})]}),e(Ae,{sx:{flex:"0 1 100%",mx:2},getAriaLabel:()=>"LightCone Level Range",value:[d,S],onChange:x,onChangeCommitted:(C,m)=>Array.isArray(m)&&r(m[0],m[1]),valueLabelDisplay:"auto",min:0,max:Y,step:1,marks:!0,disabled:a}),e(Z,{value:S,onChange:C=>i(Q(C??0,n,Y)),sx:{px:1,flex:"0 0 3em"},inputProps:{sx:{textAlign:"center"}},disabled:a})]})}function Xt({levelLow:n,levelHigh:t,setLow:s,setHigh:i,setBoth:r,dark:o=!1,disabled:a=!1,showLevelText:h=!1}){const{t:p}=N("artifact"),[d,u]=c.useState(n),[S,g]=c.useState(t),x=c.useCallback((C,m)=>{if(typeof m=="number")throw new TypeError;const[R,k]=m;u(R),g(k)},[u,g]);return c.useEffect(()=>u(n),[u,n]),c.useEffect(()=>g(t),[g,t]),l(f,{sx:{width:"100%",display:"flex",alignItems:"center",bgcolor:o?"contentNormal.main":"contentLight.main",overflow:"visible"},children:[l(f,{sx:{width:"max-content",height:32,display:"flex"},children:[h?l(he,{children:[e("span",{style:{padding:"0 1em",width:"max-content",borderRadius:"4px 0 0 4px",display:"flex",justifyContent:"center",alignItems:"center",color:"rgba(255,255,255,0.9)",backgroundColor:"rgb(30,120,200)"},children:p("levelSliderTitle")}),e(K,{orientation:"vertical",flexItem:!0})]}):void 0,e(Z,{value:d,onChange:C=>s(Q(C??0,0,t)),sx:{px:1,width:"3em"},inputProps:{sx:{textAlign:h?"right":"center"}},disabled:a})]}),e(Ae,{sx:{flex:"0 1 100%",mx:2},getAriaLabel:()=>"Arifact Level Range",value:[d,S],onChange:x,onChangeCommitted:(C,m)=>Array.isArray(m)&&r(m[0],m[1]),valueLabelDisplay:"auto",min:0,max:ee[5],step:1,marks:!0,disabled:a}),e(Z,{value:S,onChange:C=>i(Q(C??0,n,ee[5])),sx:{px:1,flex:"0 0 3em"},inputProps:{sx:{textAlign:"center"}},disabled:a})]})}function Pe(n,t=new Map){const s=t.get(n);if(s)return s;const{val:i,meta:{tag:r,op:o,ops:a,usedCats:h}}=n,p=r&&je(r,(k,D)=>h.has(D)),d=pe(i,ve(at(r))),u=new Set;function S(k,D){return k.map((z,G)=>{const L=Pe(z,t);return L.name?(u.add(L),L.name):(L.deps.forEach(_=>u.add(_)),L.prec>=D?L.formula:l("span",{children:["(",L.formula,")"]},G))})}let g,x=1/0;switch(o){case"const":g=d,x=1/0;break;case"sum":case"prod":case"max":case"min":{const{head:k,joiner:D,end:z}=re[o];x=re[o].prec,g=l("span",{children:[k,S(a,x).map((G,L)=>l(c.Fragment,{children:[G,L<a.length-1&&D]},L)),z]})}break;case"sumfrac":{const[k]=S(a,2),[D,z]=S(a,1);g=l("span",{children:[k," / (",D," + ",z,")"]}),x=re.prod.prec;break}case"floor":g=`⌊${a[0].val}⌋`,x=1/0;break;default:ze(o)}let C,m;p&&(C=l("span",{children:[e(Me,{tag:p})," ",d]}),m=void 0);const R={name:C,formula:g,prec:x,sheet:m,deps:[...new Set(u)]};return t.set(n,R),R}const re={sum:{head:"",joiner:" + ",end:"",prec:1},prod:{head:"",joiner:" * ",end:"",prec:2},max:{head:"Max(",joiner:", ",end:")",prec:1/0},min:{head:"Min(",joiner:", ",end:")",prec:1/0}};function Jt({character:n,charOpt:t,children:s}){const i=Qt(n),r=c.useMemo(()=>Fe([...Ne([n.key]),...i,X.common.lvl.add(80),X.common.res.add(.1),X.common.isBroken.add(0),X.common.maxToughness.add(100),He.common.critMode.add("avg"),...t.conditionals.flatMap(({sheet:o,src:a,dst:h,condKey:p,condValue:d})=>xe("preset0",We(o,a,h)(p,d))),...t.bonusStats.flatMap(({tag:o,value:a})=>xe("preset0",{tag:{...o},value:Je(a)}))]),[n.key,i,t.conditionals,t.bonusStats]);return e(Tt.Provider,{value:r,children:s})}function Qt(n){const t=Ht(n==null?void 0:n.equippedLightCone),s=Ge(n==null?void 0:n.equippedRelics),i=c.useMemo(()=>{const o=t;return o?Ue(o.key,o.level,o.ascension,o.superimpose):[]},[t]),r=c.useMemo(()=>s?lt(Object.values(s).filter($e)):[],[s]);return c.useMemo(()=>n?Ve(n.key,...Xe(n,1),...i,...r):[],[n,i,r])}function Zt(){const{database:n}=v(),{key:t}=q(),{bonusStats:s}=W(t),i=c.useCallback((o,a,h)=>n.charOpts.setBonusStat(t,o,a,h),[n,t]),r=o=>{const a=Yt(o,t);n.charOpts.setBonusStat(t,a,0)};return l(b,{children:[e(H,{title:"Bonus Stats"}),e(K,{}),e(w,{children:l(E,{spacing:1,children:[s.map(({tag:o,value:a},h)=>e(nn,{tag:o,value:a,setValue:p=>i(o,p),onDelete:()=>i(o,null),setTag:p=>i(p,0)},JSON.stringify(o)+h)),e(tn,{onSelect:r})]})})]})}function Yt(n,t){return{src:t,dst:t,et:"own",q:n,qt:"premod",sheet:"agg"}}const en=["hp","hp_","def","def_","atk","atk_","spd","spd_","dmg_","enerRegen_","brEffect_","crit_","crit_dmg_","eff_","eff_res_","heal_"];function tn({tag:n={},onSelect:t}){var s;return e(U,{title:(n&&((s=ut.subset(n)[0])==null?void 0:s.title))??"Add Bonus Stat",children:en.map(i=>e(P,{onClick:()=>t(i),children:i},i))})}function nn({tag:n,setTag:t,value:s,setValue:i,onDelete:r}){var a;const o=(a=n.name||n.q)==null?void 0:a.endsWith("_");return e(b,{bgt:"light",children:l(w,{sx:{display:"flex",gap:1,justifyContent:"space-around"},children:[e(ge,{sx:{m:"auto"},children:n.q}),n.q==="dmg_"&&e(sn,{tag:n,setElementalType:h=>{const{elementalType:p,...d}=n;t(h?{...d,elementalType:h}:d)}}),e(ct,{float:!0,value:s,sx:{flexBasis:150,flexGrow:1,height:"100%"},onChange:i,placeholder:"Stat Value",size:"small",inputProps:{sx:{textAlign:"right"}},InputProps:{endAdornment:l(dt,{position:"end",sx:{ml:0},children:[o?"%":void 0," ",e(ne,{"aria-label":"Delete Bonus Stat",onClick:r,edge:"end",children:e(Gt,{fontSize:"small"})})]})}})]})})}function sn({tag:n,setElementalType:t}){return l(U,{title:n.elementalType??"No Element",children:[e(P,{onClick:()=>t(null),children:"No Element"}),Qe.map(s=>e(P,{onClick:()=>t(s),children:s},s))]})}function on(){const n=Ce();return e(b,{children:e(w,{children:n==null?void 0:n.listFormulas(le.listing.formulas).map((t,s)=>e(rn,{read:t},s))})})}function rn({read:n}){const t=Ce();if(!t)return null;const s=t.compute(n),i=n.tag.name||n.tag.q,r=Pe(s);return l(f,{sx:{display:"flex",gap:1,alignItems:"center"},children:[e(f,{sx:{flexGrow:1},children:e(Me,{tag:n.tag})}),pe(s.val,ve(i??"")),e(Ze,{title:l(T,{component:"div",children:[e(f,{children:r.name}),e(K,{}),e(f,{children:r.formula}),e(E,{spacing:1,sx:{pl:1,pt:1},children:r.deps.map((o,a)=>l(f,{children:[e(f,{children:o.name}),e(K,{}),l(f,{children:[" ",o.formula]})]},a))})]}),children:e(ht,{})})]})}function an(){const{key:n}=q(),{conditionals:t}=W(n),[s,i]=c.useState(""),r=c.useMemo(()=>{const o=t.map(a=>a.sheet).filter(Ye);return s&&o.push(s),[...new Set(o)].sort(a=>a===s?-1:1)},[t,s]);return l(E,{spacing:1,sx:{pt:1},children:[e(Wt,{lcKey:s,setLCKey:i,label:"Search Light Cone"}),e(f,{children:e(j,{container:!0,columns:3,spacing:1,children:r.map(o=>e(j,{item:!0,xs:1,children:e(pt,{lcKey:o})},o))})})]})}function ln(n){const{database:t}=v();return Le(t.generatedBuildList,n)}const cn=c.memo(function(){const{optConfig:t}=c.useContext(O),s=ln(t.generatedBuildListId??"");return e(E,{spacing:1,children:s==null?void 0:s.builds.map((i,r)=>e(b,{children:l(w,{children:[l(f,{sx:{display:"flex",justifyContent:"space-between",gap:1},children:[l(T,{children:["Build ",r+1,": ",pe(i.value)]}),e(dn,{build:i})]}),e(Te,{relicIds:i.relicIds,lightConeId:i.lightConeId})]})},`${r}-${i.lightConeId}-${Object.values(i.relicIds).join("-")}`))})});function dn({build:{relicIds:n,lightConeId:t}}){const{t:s}=N("build"),{database:i}=v(),{key:r}=q(),o=c.useCallback(()=>{Object.entries(n).forEach(([a,h])=>i.chars.setEquippedRelic(r,a,h)),i.chars.setEquippedLightCone(r,t)},[r,i.chars,t,n]);return e(y,{color:"info",size:"small",startIcon:e(gt,{}),onClick:o,children:s("buildDisplay.equipToCrr")})}const un=c.memo(function({disabled:t=!1}){const{database:s}=v(),{optConfigId:i,optConfig:r}=c.useContext(O);return l(b,{bgt:"light",children:[e(w,{sx:{display:"flex",gap:1},children:e(T,{sx:{fontWeight:"bold"},children:"LightCone Level Filter"})}),e(K,{}),e(Vt,{levelLow:(r==null?void 0:r.lcLevelLow)??Y,levelHigh:(r==null?void 0:r.lcLevelHigh)??Y,setLow:o=>s.optConfigs.set(i,{lcLevelLow:o}),setHigh:o=>s.optConfigs.set(i,{lcLevelHigh:o}),setBoth:(o,a)=>s.optConfigs.set(i,{lcLevelLow:o,lcLevelHigh:a}),disabled:t})]})});function hn({numLightCone:n,disabled:t}){const{database:s}=v(),{optConfigId:i,optConfig:r}=c.useContext(O),[o,a,h]=me();return e(b,{bgt:"light",children:e(w,{children:l(E,{spacing:1,children:[l($,{sx:{display:"flex",gap:2,justifyContent:"space-between",alignItems:"center"},children:[l($,{sx:{display:"flex",gap:1,justifyContent:"space-between"},children:["LightCones:"," ",e(ge,{color:n?"primary":"error",children:n})]}),e(y,{sx:{flexGrow:1},startIcon:r.optLightCone?e(Bt,{}):e(jt,{}),color:r.optLightCone?"success":"secondary",onClick:()=>s.optConfigs.set(i,{optLightCone:!r.optLightCone}),children:"Optimize LightCone"})]}),e(pn,{show:o,onClose:h}),e(y,{color:"info",fullWidth:!0,onClick:a,disabled:t||!r.optLightCone,children:"LightCone Filter Config"})]})})})}function pn({show:n,onClose:t,disabled:s}){const{database:i}=v(),{optConfigId:r,optConfig:o}=c.useContext(O);return e(fe,{open:n,onClose:t,children:l(b,{children:[e(H,{title:"LightCone Filter",action:e(ne,{onClick:t,children:e(se,{})})}),e(K,{}),e(w,{children:e(c.Suspense,{fallback:e(ke,{width:"100%",height:"500px"}),children:l(E,{spacing:1,children:[e(un,{disabled:s}),e(gn,{disabled:s}),e(y,{disabled:s,onClick:()=>i.optConfigs.set(r,{useEquippedLightCone:!o.useEquippedLightCone}),color:o.useEquippedLightCone?"success":"secondary",children:"Use equipped LightCone"})]})})})]})})}function gn({disabled:n}){const{database:t}=v(),{optConfigId:s,optConfig:i}=c.useContext(O),{lightConePaths:r}=i,o=ue(t.lightCones),{key:a}=q(),h=c.useMemo(()=>o&&i.optLightCone?t.lightCones.values.reduce((p,{key:d,level:u,location:S})=>{if(u<i.lcLevelLow||u>i.lcLevelHigh||S&&!i.useEquippedLightCone&&S!==a)return p;const g=Oe(d).path;return g&&p[g]++,p},te(ye,()=>0)):te(ye,()=>0),[a,o,t.lightCones,i.lcLevelLow,i.lcLevelHigh,i.optLightCone,i.useEquippedLightCone]);return e(Kt,{onChange:p=>t.optConfigs.set(s,{lightConePaths:p}),value:r,disabled:n,totals:h,fullWidth:!0})}const fn=c.memo(function({disabled:t=!1}){const{database:s}=v(),{optConfigId:i,optConfig:r}=c.useContext(O);return l(b,{bgt:"light",children:[e(w,{sx:{display:"flex",gap:1},children:e(T,{sx:{fontWeight:"bold"},children:"Relic Level Filter"})}),e(K,{}),e(Xt,{levelLow:(r==null?void 0:r.levelLow)??ee[5],levelHigh:(r==null?void 0:r.levelHigh)??ee[5],setLow:o=>s.optConfigs.set(i,{levelLow:o}),setHigh:o=>s.optConfigs.set(i,{levelHigh:o}),setBoth:(o,a)=>s.optConfigs.set(i,{levelLow:o,levelHigh:a}),disabled:t})]})});function Cn({disabled:n=!1,setFilter4Cavern:t,setFilter2Cavern:s,setFilter2Planar:i,setSetFilter4Cavern:r,setSetFilter2Cavern:o,setSetFilter2Planar:a}){const[h,p,d]=me();return l(b,{bgt:"light",children:[e(fe,{open:h,onClose:d,children:e(mn,{onClose:d,setFilter2Cavern:s,setFilter4Cavern:t,setFilter2Planar:i,setSetFilter2Cavern:o,setSetFilter4Cavern:r,setSetFilter2Planar:a})}),l(w,{sx:{display:"flex",gap:1},children:[l(f,{sx:{flexGrow:1,display:"flex",gap:1,flexDirection:"column"},children:[t.length<=1?l(U,{disabled:n,title:t[0]?l("span",{children:["Force 4-Set:"," ",e("strong",{children:e(B,{setKey:t[0]})})]}):"Select to force 4-Set",sx:{flexGrow:1},children:[e(P,{onClick:()=>r([]),children:"No 4-Set"}),ce.map(u=>e(P,{onClick:()=>r([u]),children:e(B,{setKey:u})},u))]}):e(y,{disabled:!0,children:l("span",{children:[e("strong",{children:t.length})," Relic 4p-set Selected"]})}),s.length<=1?l(U,{disabled:n,title:s[0]?l("span",{children:["Force 2-Set:"," ",e("strong",{children:e(B,{setKey:s[0]})})]}):"Select to force 2-Set",sx:{flexGrow:1},children:[e(P,{onClick:()=>o([]),children:"No 2-Set"}),ce.map(u=>e(P,{onClick:()=>o([u]),children:e(B,{setKey:u})},u))]}):e(y,{disabled:!0,children:l("span",{children:[e("strong",{children:s.length})," Relic Cavern 2p-set Selected"]})}),i.length<=1?l(U,{disabled:n,title:i[0]?l("span",{children:["Force 2-Set:"," ",e("strong",{children:e(B,{setKey:i[0]})})]}):"Select to force 2-Set",sx:{flexGrow:1},children:[e(P,{onClick:()=>a([]),children:"No 2-Set"}),we.map(u=>e(P,{onClick:()=>a([u]),children:e(B,{setKey:u})},u))]}):e(y,{disabled:!0,children:l("span",{children:[e("strong",{children:i.length})," Relic Planar 2p-set Selected"]})})]}),e(f,{sx:{display:"flex",alignItems:"stretch"},children:e(y,{disabled:n,onClick:p,color:"info",children:"Advanced Set-Filter Config"})})]})]})}function mn({onClose:n,setFilter4Cavern:t,setFilter2Cavern:s,setFilter2Planar:i,setSetFilter4Cavern:r,setSetFilter2Cavern:o,setSetFilter2Planar:a}){return l(b,{children:[e(H,{title:"Advanced Set-Filter Config",action:e(ne,{onClick:n,children:e(se,{})})}),e(K,{}),l(w,{children:[e(T,{variant:"h6",children:"Cavern"}),l(f,{sx:{display:"flex",gap:1,mb:1},children:[e(y,{disabled:!t.length,onClick:()=>r([]),children:"Reset 4p filter"}),e(y,{disabled:!s.length,onClick:()=>o([]),children:"Reset 2p filter"})]}),e(j,{container:!0,spacing:1,children:ce.map(h=>e(j,{item:!0,xs:1,md:2,lg:3,children:e(xn,{setKey:h,setFilter4Cavern:t,setFilter2Cavern:s,setSetFilter4Cavern:r,setSetFilter2Cavern:o})},h))}),e(T,{variant:"h6",children:"Planar"}),e(f,{sx:{display:"flex",gap:1,mb:1},children:e(y,{disabled:!s.length,onClick:()=>a([]),children:"Reset 2p filter"})}),e(j,{container:!0,spacing:1,children:we.map(h=>e(j,{item:!0,xs:1,md:2,lg:3,children:e(yn,{setKey:h,setFilter2Planar:i,setSetFilter2Planar:a})},h))})]})]})}function xn({setKey:n,setFilter4Cavern:t,setFilter2Cavern:s,setSetFilter4Cavern:i,setSetFilter2Cavern:r}){return l(b,{bgt:"light",children:[e(H,{title:e(B,{setKey:n}),avatar:e(Ie,{src:Ke(n,Re(n)),size:2})}),l(De,{fullWidth:!0,children:[e(y,{color:!t.length||t.includes(n)?"success":"secondary",onClick:()=>i(t.length?de([...t],n):[n]),children:"Allow 4p"}),e(y,{color:!s.length||s.includes(n)?"success":"secondary",onClick:()=>r(s.length?de([...s],n):[n]),children:"Allow 2p"})]})]})}function yn({setKey:n,setFilter2Planar:t,setSetFilter2Planar:s}){return l(b,{bgt:"light",children:[e(H,{title:e(B,{setKey:n}),avatar:e(Ie,{src:Ke(n,Re(n)),size:2})}),e(De,{fullWidth:!0,children:e(y,{color:!t.length||t.includes(n)?"success":"secondary",onClick:()=>s(t.length?de([...t],n):[n]),children:"Allow 2p"})})]})}function bn({relicsBySlot:n}){const[t,s,i]=me();return e(b,{bgt:"light",children:e(w,{children:l(E,{spacing:1,children:[e($,{sx:{display:"flex",gap:2,justifyContent:"space-between"},children:Ee.map(r=>e(F,{relicsBySlot:n,slotKey:r},r))}),e(Sn,{show:t,onClose:i,relicsBySlot:n}),e(y,{color:"info",fullWidth:!0,onClick:s,children:"Relic Filter Config"})]})})})}function F({relicsBySlot:n,slotKey:t}){return l(T,{children:["Relic ",t," ",e(ge,{color:n[t].length?"primary":"error",children:n[t].length})]})}function Sn({relicsBySlot:n,show:t,onClose:s,disabled:i}){const{database:r}=v(),{optConfigId:o,optConfig:a}=c.useContext(O);return e(fe,{open:t,onClose:s,children:l(b,{children:[e(H,{title:"Relic Filter",action:e(ne,{onClick:s,children:e(se,{})})}),e(K,{}),e(w,{children:e(c.Suspense,{fallback:e(ke,{width:"100%",height:"500px"}),children:l(E,{spacing:1,children:[e(fn,{disabled:i}),e(Ln,{relicsBySlot:n,disabled:i}),e(vn,{disabled:i}),e(y,{disabled:i,onClick:()=>r.optConfigs.set(o,{useEquipped:!a.useEquipped}),color:a.useEquipped?"success":"secondary",children:"Use equipped Relics"})]})})})]})})}function Ln({relicsBySlot:n,disabled:t}){const{database:s}=v(),{optConfigId:i,optConfig:r}=c.useContext(O),o=a=>{const h=et([...be[a]]),p={body:r.slotBodyKeys??[],feet:r.slotFeetKeys??[],sphere:r.slotSphereKeys??[],rope:r.slotRopeKeys??[]},d={body:u=>s.optConfigs.set(i,{slotBodyKeys:u}),feet:u=>s.optConfigs.set(i,{slotFeetKeys:u}),sphere:u=>s.optConfigs.set(i,{slotSphereKeys:u}),rope:u=>s.optConfigs.set(i,{slotRopeKeys:u})};return e($,{sx:{display:"flex",gap:1,flexWrap:"wrap"},children:be[a].map(u=>e(y,{disabled:t,variant:p[a].includes(u)?"contained":"outlined",onClick:()=>d[a](h([...p[a]],u)),children:e(Pt,{statKey:u,showPercent:!0})},u))})};return e(b,{bgt:"light",children:e(w,{children:l(E,{spacing:1,children:[l($,{sx:{display:"flex",justifyContent:"space-between"},children:[e(F,{slotKey:"head",relicsBySlot:n}),e(F,{slotKey:"hands",relicsBySlot:n})]}),e(F,{slotKey:"body",relicsBySlot:n}),o("body"),e(F,{slotKey:"feet",relicsBySlot:n}),o("feet"),e(F,{slotKey:"sphere",relicsBySlot:n}),o("sphere"),e(F,{slotKey:"rope",relicsBySlot:n}),o("rope")]})})})}function vn({disabled:n}){const{database:t}=v(),{optConfigId:s,optConfig:i}=c.useContext(O),{setFilter4Cavern:r,setFilter2Cavern:o,setFilter2Planar:a}=i,h=c.useCallback(u=>{t.optConfigs.set(s,{setFilter2Cavern:u})},[t,s]),p=c.useCallback(u=>{t.optConfigs.set(s,{setFilter4Cavern:u})},[t,s]),d=c.useCallback(u=>{t.optConfigs.set(s,{setFilter2Planar:u})},[t,s]);return e(Cn,{disabled:n,setFilter2Cavern:o,setFilter4Cavern:r,setFilter2Planar:a,setSetFilter2Cavern:h,setSetFilter4Cavern:p,setSetFilter2Planar:d})}function kn(){const{key:n}=q(),{optConfigId:t}=W(n),{database:s}=v();return c.useEffect(()=>{if(t)return;const i=s.optConfigs.new();s.charOpts.set(n,{optConfigId:i})},[s,t,n]),t?l(tt,{optConfigId:t,children:[e(wn,{}),e(cn,{})]}):null}function wn(){const{t:n}=N("optimize"),{database:t}=v(),s=Ce(),{key:i}=q(),{target:r}=W(i),[o,a]=c.useState(8),[h,p]=c.useState(void 0),{optConfig:d,optConfigId:u}=c.useContext(O),S=ue(t.relics),g=c.useMemo(()=>{const L={body:d.slotBodyKeys,feet:d.slotFeetKeys,sphere:d.slotSphereKeys,rope:d.slotRopeKeys},_=I=>["body","feet","sphere","rope"].includes(I);return S&&t.relics.values.reduce((I,A)=>{const{slotKey:M,mainStatKey:ie,level:oe,location:V}=A;return oe<d.levelLow||oe>d.levelHigh||V&&!d.useEquipped&&V!==i||_(M)&&!L[M].includes(ie)||I[A.slotKey].push(A),I},{head:[],hands:[],feet:[],body:[],sphere:[],rope:[]})},[i,t.relics,d.levelHigh,d.levelLow,d.slotBodyKeys,d.slotFeetKeys,d.slotRopeKeys,d.slotSphereKeys,d.useEquipped,S]),x=ue(t.lightCones),C=c.useMemo(()=>x&&t.lightCones.values.filter(({key:L,level:_,location:I})=>{if(!d.optLightCone)return I===i;if(_<d.lcLevelLow||_>d.lcLevelHigh||I&&!d.useEquippedLightCone&&I!==i)return!1;const{path:A}=Oe(L);return!!d.lightConePaths.includes(A)}),[i,t.lightCones,d.lcLevelLow,d.lcLevelHigh,d.optLightCone,d.lightConePaths,d.useEquippedLightCone,x]),m=c.useMemo(()=>ft(Object.values(g))*C.length,[C.length,g]),[R,k]=c.useState(!1),D=c.useRef(()=>{});c.useEffect(()=>()=>D.current(),[]);const z=c.useCallback(async()=>{if(!s)return;const L=new Promise(M=>D.current=M);p(void 0),k(!0);const _=(d.statFilters??[]).filter(M=>!M.disabled),I=Ct(i,s,[{tag:r,multiplier:1}],10,_,d.setFilter2Cavern,d.setFilter4Cavern,d.setFilter2Planar,C,g,o,p);L.then(()=>I.terminate("user cancelled"));let A;try{A=await I.results}catch{return}finally{D.current=()=>{},k(!1)}A.length&&t.optConfigs.newOrSetGeneratedBuildList(u,{builds:A.slice(0,5).map(({ids:M,value:ie})=>({lightConeId:M[0],relicIds:te(Ee,(oe,V)=>M[V+1]),value:ie})),buildDate:Date.now()})},[s,d.statFilters,d.setFilter2Cavern,d.setFilter4Cavern,d.setFilter2Planar,i,r,C,g,o,t.optConfigs,u]),G=c.useCallback(()=>{D.current(),k(!1)},[D]);return e(b,{children:e(w,{children:l(E,{spacing:1,children:[e(mt,{}),e(hn,{numLightCone:C.length}),e(bn,{relicsBySlot:g}),h&&e(In,{progress:h,total:m}),l(f,{sx:{display:"flex",justifyContent:"space-between"},children:[e(xt,{numWorkers:o,setNumWorkers:a}),e(y,{disabled:!m,onClick:R?G:z,color:R?"error":"primary",startIcon:R?e(se,{}):e(yt,{}),children:n(R?"cancel":"optimize")})]})]})})})}function J({value:n}){const t=n.toLocaleString();return e(f,{sx:{fontFamily:"Monospace",display:"inline"},children:t})}function In(n){const{t}=N("optimize"),{computed:s,remaining:i,skipped:r}=n.progress,o=s+i,a=Math.log1p(o)/Math.log1p(n.total),h=i/o*a;return l(f,{children:[l(T,{children:[t("computed"),": ",e(J,{value:s})," /"," ",e(J,{value:o})," "]}),l(T,{children:[t("computed + skipped"),": ",e(J,{value:s+r})," /"," ",e(J,{value:n.total})]}),e(bt,{variant:"determinate",value:(1-h)*100,sx:{height:10,borderRadius:5}})]})}function Rn(){const{key:n}=q(),{conditionals:t}=W(n),[s,i]=c.useState(""),r=c.useMemo(()=>{const o=t.map(a=>a.sheet).filter(nt);return s&&o.push(s),[...new Set(o)].sort(a=>a===s?-1:1)},[t,s]);return l(E,{spacing:1,sx:{pt:1},children:[e(Ut,{relicSetKey:s,setRelicSetKey:i,label:"Search Relic Set"}),e(f,{children:e(j,{container:!0,columns:3,spacing:1,children:r.map(o=>e(j,{item:!0,xs:1,children:e(St,{setKey:o})},o))})})]})}const Dn=210,qe=c.createContext(Dn),En=0,ae=33,_e=c.createContext(0);function Mn(){const n=c.useMemo(()=>[["char","Character",e(Kn,{},"char")],["relicCond","Relic Conditionals",e(Rn,{},"relicCond")],["lightConeCond","Light Cone Conditionals",e(an,{},"lightConeCond")],["opt","Optimize",e(On,{},"opt")]],[]);return e(_e.Provider,{value:n.length,children:e(E,{gap:1,children:n.map(([t,s,i],r)=>e(Tn,{title:s,index:r,children:i},t))})})}function Tn({index:n,title:t,children:s}){const[i,r]=vt(),o=c.useContext(_e),a=c.useContext(qe);return l(he,{children:[e(b,{sx:h=>({outline:`solid ${h.palette.secondary.main}`,position:"sticky",top:a+n*ae,bottom:En+(o-1-n)*ae,zIndex:100}),children:e($t,{onClick:r,sx:{px:1},children:e(T,{variant:"h6",children:t})})}),e(f,{ref:i,sx:{scrollMarginTop:a+(n+1)*ae},children:s})]})}function Kn(){const n=q(),{key:t}=n,[s,i]=c.useState(void 0);return l(E,{spacing:1,children:[l(f,{sx:{display:"flex",gap:1},children:[l(f,{sx:{minWidth:"350px"},children:[e(zt,{character:n,hideStats:!0}),e(Ft,{characterKey:s,onClose:()=>i(void 0)}),e(y,{fullWidth:!0,disabled:!t,onClick:()=>t&&i(t),children:"Edit Character"}),e(on,{})]}),e(An,{})]}),e(Zt,{}),e(Lt,{formulasRead:le.listing.formulas,buffsRead:le.listing.buffs})]})}function On(){return e(kn,{})}function An(){const{equippedRelics:n,equippedLightCone:t}=q();return e(b,{sx:{width:"100%"},children:e(w,{children:e(Te,{relicIds:n,lightConeId:t})})})}function Pn({character:{key:n},charOpt:{target:t}}){const{database:s}=v();return e(kt,{optTarget:t,setOptTarget:i=>s.charOpts.set(n,{target:i}),buttonProps:{fullWidth:!0,sx:{height:"100%"}}})}function Xn(){const{database:n}=v(),[t,s]=c.useState(st[0]),{t:i}=N(["charNames_gen","page_character"]),r=Nt(t);c.useEffect(()=>{t&&!r&&n.chars.getOrCreate(t)},[t,r,n.chars]);const o=W(t);c.useEffect(()=>{t&&!o&&n.charOpts.getOrCreate(t)},[t,o,n.charOpts]),wt(c.useMemo(()=>`Optimize - ${i(t?"charNames_gen:Character":"Optimize")}`,[t,i]));const a=c.useMemo(()=>{const x=te(t?[t]:[],C=>e(_t,{genderedKey:qt(C)}));return{srcDisplay:x,dstDisplay:x}},[t]),h=c.useCallback((g,x,C,m,R)=>{!it(g)||!Se(C)||!(m===null||Se(m))||!ot(g,x)||n.charOpts.setConditional(t,g,x,C,m,R)},[t,n.charOpts]),p=c.useMemo(()=>({src:t,dst:t,preset:"preset0"}),[t]),[d,u]=c.useState(),S=c.useMemo(()=>({read:d,setRead:u}),[d]);return l(f,{children:[e(It,{charKey:t,setCharKey:g=>g&&s(g)}),r&&o&&e(rt.Provider,{value:r,children:e(Ot.Provider,{value:p,children:e(Jt,{character:r,charOpt:o,children:e(Rt.Provider,{value:a,children:e(Dt.Provider,{value:o.conditionals,children:e(Et.Provider,{value:h,children:l(At.Provider,{value:S,children:[e(Mt,{}),l(f,{sx:{display:"flex",gap:1,flexDirection:"column",mt:2},children:[e(Pn,{character:r,charOpt:o}),e(qe.Provider,{value:0,children:e(Mn,{})})]})]})})})})})})})]})}export{Xn as default};
